{% extends "client/_base.html" %}
{% set current_step = 1 %}

{% block title %}Contact Information{% endblock %}

{% block extra_css %}
<style>
  .phone-row {
    display: flex;
    gap: 0.5rem;
  }

  .phone-code {
    width: 80px;
    flex-shrink: 0;
    font-family: monospace;
    font-size: 0.82rem;
  }

  .portal-card h2 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .portal-card .subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 1.75rem;
    line-height: 1.5;
  }

  .form-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .btn-continue {
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.7rem 1rem;
    background: var(--text);
    color: var(--bg);
    border: none;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .btn-continue:hover:not(:disabled) { opacity: 0.85; }
  .btn-continue:disabled { opacity: 0.4; cursor: not-allowed; }

  .privacy-note {
    font-size: 0.72rem;
    color: var(--text-muted);
    text-align: center;
    margin-top: 1rem;
    line-height: 1.5;
  }
</style>
{% endblock %}


{% block content %}

<div class="portal-card">

  <h2>Let's get started</h2>
  <p class="subtitle">
    Please enter your contact details below. Your information is handled
    securely and shared only with your legal team.
  </p>

  <div class="error-banner" id="errorBanner"></div>

  <form class="form-stack" id="contactForm" onsubmit="handleSubmit(event)" novalidate>

    <div class="form-group">
      <label class="form-label form-required" for="fullName">Full Name</label>
      <input
        class="form-input"
        id="fullName"
        name="full_name"
        type="text"
        placeholder="Ahmed Al Marri"
        autocomplete="name"
        required
      />
    </div>

    <div class="form-group">
      <label class="form-label form-required" for="email">Email Address</label>
      <input
        class="form-input"
        id="email"
        name="email"
        type="email"
        placeholder="ahmed@example.com"
        autocomplete="email"
        required
      />
    </div>

    <div class="form-group">
      <label class="form-label form-required" for="phone">Phone Number</label>
      <div class="phone-row">
        <select class="form-input phone-code" id="countryCode" name="country_code">
          <option value="+971" selected>+971 ðŸ‡¦ðŸ‡ª</option>
          <option value="+966">+966 ðŸ‡¸ðŸ‡¦</option>
          <option value="+965">+965 ðŸ‡°ðŸ‡¼</option>
          <option value="+973">+973 ðŸ‡§ðŸ‡­</option>
          <option value="+974">+974 ðŸ‡¶ðŸ‡¦</option>
          <option value="+968">+968 ðŸ‡´ðŸ‡²</option>
          <option value="+44"> +44  ðŸ‡¬ðŸ‡§</option>
          <option value="+1">  +1   ðŸ‡ºðŸ‡¸</option>
          <option value="+91"> +91  ðŸ‡®ðŸ‡³</option>
          <option value="+92"> +92  ðŸ‡µðŸ‡°</option>
          <option value="+20"> +20  ðŸ‡ªðŸ‡¬</option>
          <option value="+962">+962 ðŸ‡¯ðŸ‡´</option>
          <option value="+961">+961 ðŸ‡±ðŸ‡§</option>
        </select>
        <input
          class="form-input"
          id="phone"
          name="phone"
          type="tel"
          placeholder="50 123 4567"
          autocomplete="tel"
          style="flex:1"
          required
        />
      </div>
      <span class="form-hint">Used for WhatsApp updates from your legal team.</span>
    </div>

    <button class="btn-continue" type="submit" id="continueBtn">
      Continue
    </button>

  </form>

  <p class="privacy-note">
    Your data is encrypted and only accessible to your assigned legal team.
  </p>

</div>

{% endblock %}


{% block extra_js %}
<script>
async function handleSubmit(e) {
  e.preventDefault();

  const errBanner = document.getElementById('errorBanner');
  errBanner.classList.remove('visible');

  const name  = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim();
  const code  = document.getElementById('countryCode').value;
  const phone = document.getElementById('phone').value.trim().replace(/\s/g, '');

  // Client-side validation
  if (!name) return showError('Please enter your full name.');
  if (!email || !email.includes('@')) return showError('Please enter a valid email address.');
  if (!phone) return showError('Please enter your phone number.');

  const btn = document.getElementById('continueBtn');
  btn.disabled = true;
  btn.textContent = 'Please waitâ€¦';

  try {
    const res = await fetch('/client/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        full_name: name,
        email:     email,
        phone:     code + phone,
        channel:   'web',
      }),
    });

    const data = await res.json();

    if (res.ok && data.success) {
      const { reference_id, portal_link } = data.data.client;
      // Redirect to the pre-authenticated portal deep link (step 2)
      window.location.href = portal_link + '&step=upload';
    } else {
      showError(data.error || 'Something went wrong. Please try again.');
    }
  } catch (err) {
    showError('Network error. Please check your connection and try again.');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Continue';
  }
}

function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = msg;
  el.classList.add('visible');
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>
{% endblock %}
